AWSTemplateFormatVersion: '2010-09-09'
Description: HTTP API (IAM-restricted) with VPC Link to Internal ALB; POST /create-request

Parameters:
  VpcId:
    Type: String
    Description: VPC Id (same VPC as your ALB and ECS)

  PrivateSubnetIds:
    Type: CommaDelimitedList
    Description: Private subnet IDs for the VPC Link ENIs

  InternalALBListenerArn:
    Type: String
    Description: ARN of the Internal ALB HTTP listener (e.g., !ImportValue ApprovalInternalALBListenerArn)

  InternalALBSecurityGroupId:
    Type: String
    Description: Security Group ID attached to the Internal ALB (e.g., !ImportValue ApprovalInternalALBSecurityGroupId)

  AllowedPrincipalArn:
    Type: String
    Description: IAM principal (e.g., Step Functions execution role ARN) allowed to invoke the API
    # Example: arn:aws:iam::123456789012:role/approval-sfn-exec-role

Resources:
  # SG for API Gateway VPC Link ENIs -> allow egress to ALB:80
  VpcLinkSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: SG for API Gateway VPC Link ENIs (egress to ALB:80)
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          DestinationSecurityGroupId: !Ref InternalALBSecurityGroupId

  # HTTP API defined via OpenAPI Body (so don't set Name/ProtocolType at top level)
  # Resource policy ALLOWS ONLY the specified IAM principal to Invoke.
  PrivateHttpApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Body:
        openapi: "3.0.1"
        info:
          title: "approval-iam-restricted-http-api"
          version: "1.0"
        paths: {}
        x-amazon-apigateway-policy:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                AWS: !Ref AllowedPrincipalArn
              Action: "execute-api:Invoke"
              Resource: "arn:aws:execute-api:*:*:*/**"

  # Default stage with auto-deploy
  PrivateHttpApiStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref PrivateHttpApi
      StageName: "$default"
      AutoDeploy: true

  # VPC Link (HTTP API) → Internal ALB
  PrivateVpcLink:
    Type: AWS::ApiGatewayV2::VpcLink
    Properties:
      Name: approval-iam-vpc-link
      SubnetIds: !Ref PrivateSubnetIds
      SecurityGroupIds: [ !Ref VpcLinkSecurityGroup ]

  # Integration to ALB Listener (HTTP_PROXY via VPC_LINK)
  CreateRequestIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref PrivateHttpApi
      IntegrationType: HTTP_PROXY
      ConnectionType: VPC_LINK
      ConnectionId: !Ref PrivateVpcLink
      IntegrationMethod: POST
      IntegrationUri: !Ref InternalALBListenerArn
      PayloadFormatVersion: '1.0'
      TimeoutInMillis: 29000

  # Route: POST /create-request → ALB listener via VPC Link
  CreateRequestRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref PrivateHttpApi
      RouteKey: "POST /create-request"
      Target: !Sub "integrations/${CreateRequestIntegration}"

  # Tighten ALB SG inbound to only the VPC Link SG (idempotent if already present)
  AlbIngressFromVpcLink:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref InternalALBSecurityGroupId
      SourceSecurityGroupId: !Ref VpcLinkSecurityGroup
      IpProtocol: tcp
      FromPort: 80
      ToPort: 80

Outputs:
  HttpApiId:
    Value: !Ref PrivateHttpApi
    Description: HTTP API ID
    Export: { Name: ApprovalCreateRequestApiId }

  ApiEndpoint:
    Value: !Sub "https://${PrivateHttpApi}.execute-api.${AWS::Region}.amazonaws.com"
    Description: Public execute-api endpoint (IAM restricted)
    Export: { Name: ApprovalCreateRequestApiEndpoint }

  VpcLinkId:
    Value: !Ref PrivateVpcLink
    Description: VPC Link ID
    Export: { Name: ApprovalCreateRequestVpcLinkId }

  VpcLinkSecurityGroupId:
    Value: !Ref VpcLinkSecurityGroup
    Description: SG used by API GW VPC Link ENIs
    Export: { Name: ApprovalCreateRequestVpcLinkSgId }
